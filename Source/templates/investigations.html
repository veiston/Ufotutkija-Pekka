<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>UFOtutkiJA</title>
    <link rel="icon" href="static/favicon.png" type="image/x-icon" />
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/logo.css" />
    <link rel="stylesheet" href="/static/css/button.css" />
    <link rel="stylesheet" href="/static/css/hero.css" />
    <link rel="stylesheet" href="/static/css/spotlight.css" />
    <link rel="stylesheet" href="/static/css/light.css" />
    <link rel="stylesheet" href="/static/css/card.css" />
    <link rel="stylesheet" href="/static/css/modal.css" />

    <script src="/static/js/fade-in-audio.js" defer></script>
    <script src="/static/js/spotlight.js" defer></script>
    <script src="/static/js/light.js" defer></script>
    <script src="/static/js/modal.js"></script>
  </head>
  <body>
    <audio src="/static/audio/AlienCall.mp3" id="fadeAudio" muted autoplay loop></audio>
    <div id="spotlight" class="spotlight"></div>
    <img class="light light--on" id="light" />
    <audio
      id="light-sound"
      src="/static/audio/light.mp3"
      preload="auto"
    ></audio>
    <audio
      id="light-is-breaking-sound"
      src="/static/audio/light-is-breaking.mp3"
      preload="auto"
    ></audio>
    <audio
      id="light-is-broken-sound"
      src="/static/audio/light-is-broken.mp3"
      preload="auto"
    ></audio>

    <div class="logo">Ufotutkija</div>
    <div class="hero--back" id="backImg"></div>
    <div class="hero">
      <div class="hero__container hero__background">
        <div class="hero__box">
          <div class="hero__box-header">
            <h2 id="investigationCity" class="hero__box-title"></h2>
          </div>
          <div class="hero__text-wrap">
            <div class="hero__text">
              <p id="investigationText"></p>
              <!-- messages container-->
              <div
                class="hero__actions-inner"
                id="investigationInnerActions"
              ></div>
            </div>
          </div>
          <div class="hero__actions" id="investigationActions"></div>
        </div>
      </div>
    </div>
    <script>
        const updateStep = async (step) => {
        try {
          const response = await fetch("/investigations/update-step", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ step }),
          });
          const data = await response.json();
          console.log(data);
          return data;
        } catch (error) {
          console.error(error);
        }
      };

      function showInfoModal(message, onClose) {
        showModal({
          message: message,
          buttons: [{ label: "OK", value: true }],
          onClose: onClose,
        });
      }

      function showStoryWinModal(text, onClose) {
        showModal({
          message: text,
          buttons: [{ label: "OK", value: true }],
          onClose: onClose,
        });
      }

      function showStoryDescriptionModal(text, onClose) {
        showModal({
          message: text,
          buttons: [{ label: "OK", value: true }],
          onClose: onClose,
        });
      }

      const fetchInvestigation = async () => {
        let currentStep = null;
        let story = null;
        let turnsLeft = 0;

        const textContainer = document.getElementById("investigationText");
        const actionsContainer = document.getElementById(
          "investigationActions"
        );
        const innerActionsContainer = document.getElementById(
          "investigationInnerActions"
        );
        const cityContainer = document.getElementById("investigationCity");
        const backContainer = document.getElementById("backImg");

        const renderStep = async (stepNumber) => {
          if (!turnsLeft) {
            window.location.href = "/combat";
            return;
          }

          const stepData = story.steps[stepNumber];
          textContainer.innerHTML = stepData.text;

          actionsContainer.innerHTML = "";
          innerActionsContainer.innerHTML = "";

          Object.entries(stepData.choices)
            .reverse()
            .forEach(([key, value]) => {
              if (stepData.choices[key].is_creature) {
                const article = document.createElement("article");
                article.className = "card";
                const wrapper = document.createElement("div");
                wrapper.className = "card__wrapper";

                const figure = document.createElement("figure");
                const img = document.createElement("img");
                img.src = `/static/images/character_art/${stepData.choices[key].image}`;
                img.alt = "Creature";

                figure.appendChild(img);

                const content = document.createElement("div");
                content.className = "card__content";

                const h2 = document.createElement("h2");
                h2.textContent = value.title || "No title";

                const p = document.createElement("p");
                p.textContent = value.text || "No description";

                content.appendChild(h2);
                content.appendChild(p);

                wrapper.appendChild(figure);
                wrapper.appendChild(content);

                article.appendChild(wrapper);
                article.addEventListener("click", async () => {
                  currentStep = value.next_step;
                  const updateData = await updateStep(currentStep);
                  turnsLeft = updateData?.turns_limit;

                  if (currentStep) {
                    await renderStep(currentStep);
                  }
                });
                actionsContainer.appendChild(article);
              } else {
                const button = document.createElement("button");
                button.className = key === "examine" ? "button" : "button button--gray-light";
                button.classList.add("button");
                button.textContent = value.text;
                button.addEventListener("click", async () => {
                  if (key === "examine") {


                  }

                  currentStep = value.next_step;
                  const updateData = await updateStep(currentStep);
                  turnsLeft = updateData?.turns_limit;
                  const isWin = updateData.is_win;
                  if (isWin) {
                    showStoryWinModal(story.win_text, () => {
                      window.location.href = "/menu";
                    });
                    return;
                  }

                  if (currentStep) {
                    await renderStep(currentStep);
                  }
                });
                actionsContainer.appendChild(button);
              }
            });
        };

        try {
          const response = await fetch("/investigations/start");
          story = await response.json();
          cityContainer.innerText = story.city;
          backContainer.style.backgroundImage = `url("/static/images/investigations/${story.ident}.png")`;

          if (story && story.description) {
            showStoryDescriptionModal(story.description, () => {
              currentStep = story.step;
              turnsLeft = story.turns_limit;

              renderStep(currentStep);
            });
          } else {
            currentStep = story.step;
            turnsLeft = story.turns_limit;

            renderStep(currentStep);
          }
        } catch (error) {
          console.error(error);
          textContainer.textContent = "Error loading investigation.";
        }
      };

      fetchInvestigation();
    </script>
    <div id="modalBox" class="modal" style="display: none">
      <div class="modal-content">
        <div id="modalBoxMessage"></div>
        <div id="modalBoxButtons"></div>
      </div>
    </div>
  </body>
</html>
